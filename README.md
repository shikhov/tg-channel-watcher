# Telegram Channel Watcher
Приложение отслеживает новые сообщения в каналах/чатах Telegram и пересылает те, которые подпадают под заданные правила. Пример работы: https://t.me/travelekb

## Реализация
Приложение написано на Python 3.7 с использованием фреймворка Telethon. Хранение данных в MongoDB. Для развертывания прилагаются Dockerfile и плейбуки для [Ansible](https://www.ansible.com/) и [Spot](https://simplotask.com).

## Развертывание

- Заполнить `config.py`:
  - `DBNAME` — имя БД
  - `CONNSTRING` — строка соединения с MongoDB
- Получить api_id и api_hash для приложения на https://my.telegram.org
- С помощью фреймворка Telethon произвести аутентификацию на сервере Telegram, сохранить string session. См.: https://docs.telethon.dev/en/stable/concepts/sessions.html#string-sessions
- Создать БД с именем, указанным в `config.py`, в ней создать коллекции settings и profiles
- В коллекции settings создать документ с _id: "settings" и заполнить его:
    - `profiles` — список профилей с настройками каналов (имя и активен/неактивен)
    - `sleeptimer` — период опроса каналов в секундах
    - `api_id`, `api_hash`, `session` —  значения, полученные на предыдущих шагах

Пример:
```
"_id": "settings",
"profiles": [
    {
      "name" : "travelekb",
      "enable" : true
    }
  ],
  "sleeptimer": 300,
  "api_id": 123456,
  "api_hash": "your_api_hash",
  "session": "your_string_session"
```

- В коллекции profiles создать и заполнить документы профилей:
  - `name` — имя профиля, указанное в settings
  - `channels` — идентификаторы Telegram-каналов (чатов) и номер последнего сообщения, с которого начинать отслеживание. Чтобы начать с последнего, указать 0
  - `output` — список объектов output. Объект output состоит из:
    - `rules` — правила фильтрации сообщений. Правило состоит из:
      - `regex` — регулярное выражение, на которое проверяется соообщение
      - `eval` — опциональное поле. Если оно есть, в случае совпадения с регулярным выражением дополнительно выполняется python-код из этого поля. Если результат кода True, правило считается сработавшим. Для использования фрагментов из скобок регулярного выражения можно использовать переменную `m`. Пример правила с eval:
        ```
        {
          "regex" : "(\\$\\s?\\d+|\\d+\\s?\\$)",
          "eval" : "int(m.group(1).replace('$', '')) <= 800"
        }
        ```
    - `any_matching` — true, если достаточно срабатывания одного из правил; false, если сработать должны все
    - `hide_forward` — опциональное поле. false (по умолчанию) - сообщение пересылается обычным форвардом (видно, из какого оно канала); true - сообщение пересылается без отметки о форварде. Опция применяется только к источникам-каналам (не к чатам). Также опция не работает в режиме `all_messages`, сообщения в этом случае всегда пересылаются форвардом.
    - `all_messages` — опциональное поле. Если выставлено в true, пересылаются все сообщения. Поля `rules` и `any_matching` в этом случае можно опустить. Для исключения сообщений из пересылки можно использовать поле `ex_rules`
    - `ex_rules` — список правил исключения. Работают только для режима all_messages. Состав аналогичен полю `rules`, но без eval (только regex). При срабатывании любого правила сообщение **не пересылается**
    - `output_channel` — идентификатор целевого канала, куда будут пересылаться сообщения


    _Идентификатор канала (или чата) может быть буквенным именем, ссылкой на вступление или числовым ID (см. документацию к Telethon)_

Пример профиля с rules:
```
"name": "travelekb",
"channels": {
    "piratesru": 0,
    "vandroukiru": 0,
    "turs_sale": 0
},
"output": [
  {
    "rules": [
      {
        "regex" : "екатеринбург|ебург|екб"
      }
    ],
    "any_matching": true,
    "hide_forward": true,
    "output_channel": "travelekb"
  }
]
```

Пример профиля с all_messages:
```
"name": "test_all",
"channels": {
  "t.me/+_alVeiHBjGU7MGFi": 0
},
"output": [
  {
    "all_messages": true,
    "output_channel": 68651304
  },
  {
    "all_messages": true,
    "output_channel": "durov",
    "ex_rules": [
      {
        "regex": "#реклама"
      }
    ]
  }
]
```

- Развернуть Dockerfile


## Ограничения
В режиме `rules` проверяются, очевидно, только сообщения с текстом, соответственно, пересылаются тоже только они. Фото/видео/стикеры не будут пересланы, если они не содержат подписи. Также в этом режиме не пересылаются альбомы — только первое сообщение из альбома, если на его тексте сработают правила.

В режиме `all_messages` пересылаются сообщения любых видов, включая альбомы. Отфильтровать можно, опять же, только сообщения с текстом.